## 订单管理

- 能够完成订单的创建
- 能够通查看订单的详细信息
- 能够了解订单的不同状态
- 能够完成订单支付
- 能够根据订单状态展示订单列表

![image-20230302175301287](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202303021753453.png)

![image-20230302180026507](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202303021800550.png)

![image-20230302180042145](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202303021800175.png)

### 1. 订单信息

订单信息是根据用户所选的商品生成一个临时性的订单，在预订单中除了展示待购买的商品信息外，还会将折扣、运费、总金额等信息汇总出来，由用户选择收货地址后再去创建订单完成购买。

目前支持两种方式生成订单信息，分别是购物车结算和立即购买

#### 去结算：

1. 数据验证

在购物车页面中用户选择了待购买的商品后，点击【去结算】可以查看选中的商品所生成的订单信息，此时会跳转到订单信息页面，不过在这之前要求用户至少选中了 1 个商品，否则不允许用户点击【去结算】按钮，因此首先我们需要进行数据的验证。

根据计算属性 选中总数量 可以判断用户是否至少选中了一个商品，当选中数量为 0 时表明没有选择任何商品，此时我们不允许跳转，并且将【去结算】按钮置成禁用状态，即添加事先定义好的 disabled 类名：

```vue
<view class="buttons">
 	<view :class="['button', 'payment', selectedCartsCount === 0 ? 'disabled' : '']" @tap="goToOrderCreate">
    去结算（{{ selectedCartsCount }}）
  </view>
</view>
```

```tsx
// 去结算
const goToOrderCreate = () => {
  if (selectedCartsCount.value === 0) {
    uni.showToast({
      title: '请选择商品',
      icon: 'none'
    });
    return;
  }
  // 跳转到订单创建页（填写订单）
  uni.navigateTo({ url: '/pages/order/create' });
};
```

接口调用：

接口地址：/member/order/pre

请求方式：GET

登录权限: 是

请求参数：无

成功响应的数据：

| 字段名称      | 数据类型 | 备注                   |
| ------------- | -------- | ---------------------- |
| goods         | Array    | 预订单商品信息         |
| summary       | Object   | 订订折扣、运费、金额等 |
| userAddresses | Array    | 收货人地址             |

**goods**

| 字段名称  | 数据类型 | 备注          |
| --------- | -------- | ------------- |
| id        | String   | 商品ID        |
| name      | String   | 商品名称      |
| picture   | String   | 图片地址      |
| attrsText | String   | 商品规格/型号 |
| count     | Number   | 商品数量      |
| price     | Number   | 商品原始价格  |
| payPrice  | Number   | 商品支付价格  |
| skuId     | String   | 库存单位 ID   |

**summary**

| 字段名称      | 数据类型 | 备注         |
| ------------- | -------- | ------------ |
| discountPrice | Number   | 折扣信息     |
| goodsCount    | Number   | 商品数量合计 |
| postFee       | Number   | 运费         |
| totalPayPrice | Number   | 总价（实付） |
| totalPrice    | Number   | 总价         |

**userAddresses**

| 字段名称      | 数据类型 | 备注      |
| ------------- | -------- | --------- |
| address       | String   | 详细地址  |
| userAddresses | String   | 省市区/县 |
| receiver      | String   | 收货人    |
| contact       | String   | 联系电话  |

```tsx
/**
 * 获取预付订单(填写订单)
 */
export function getMemberOrderPre() {
  return http<GetMemberOrderPreResult>({
    method: 'GET',
    url: '/member/order/pre'
  });
}
```

#### 立即购买：

在商品详情页面用户除了可以将商品添加至购物车外，还可以选择【立即购买】，从而将商品详情所对应商品直接生成订单信息，与购物车【去结算】不同的是选择【立即购买】需要将购买商品的信息传递到订单信息页面，我们通过传递参数。

在跳转到订单信息面之前需要获取当前商品详情对应的商品信息，并把这些信息传递到订单信息页面，这些信息包括 3 个数据，分别为 skuId、count 以及 addressId，这 3 个数据在之前的逻辑中我们已经处理好了，现在只需要对它们进行读取并传递即可。

我们通过实现页面之间的参数传递：

```tsx
// 点击立即购买
const handleBuyNow = (ev: SkuEvent) => {
  const skuId = ev._id;
  const count = ev.buy_num;
  const addressId = selectedAddress.value.id;
  uni.navigateTo({
    url: `/pages/order/create?skuId=${skuId}&count=${count}&addressId=${addressId}`
  });
  // 关闭 SKU 组件
  isShowSku.value = false;
};
```

订单页面接收传递过来的数据：

```tsx
const props = defineProps<{
  skuId: string;
  count: number;
  addressId: string;
}>();

onLoad(async () => {
  if (props.skuId) {
    // 如果有页面参数，调用立即购买
    orderPre.value = await getMemberOrderPreNow(props);
  } else {
    // 没有页面参数，普通预付订单
    orderPre.value = await getMemberOrderPre();
  }
});
```

接口调用：

接口地址：/member/order/pre/now

请求方式：GET

登录权限: 是

请求参数：

**Query**

| 字段名称  | 是否必须 | 默认值 | 备注       |
| --------- | -------- | ------ | ---------- |
| skuId     | 是       | 无     | 商品库存ID |
| count     | 是       | 无     | 商品数量   |
| addressId | 是       | 无     | 收货地址ID |

成功响应的数据：

| 字段名称      | 数据类型 | 备注                   |
| ------------- | -------- | ---------------------- |
| goods         | Array    | 预订单商品信息         |
| summary       | Object   | 订订折扣、运费、金额等 |
| userAddresses | Array    | 收货人地址             |

**goods**

| 字段名称  | 数据类型 | 备注          |
| --------- | -------- | ------------- |
| id        | String   | 商品ID        |
| name      | String   | 商品名称      |
| picture   | String   | 图片地址      |
| attrsText | String   | 商品规格/型号 |
| count     | Number   | 商品数量      |
| price     | Number   | 商品原始价格  |
| payPrice  | Number   | 商品支付价格  |
| skuId     | String   | 库存单位 ID   |

**summary**

| 字段名称      | 数据类型 | 备注         |
| ------------- | -------- | ------------ |
| discountPrice | Number   | 折扣信息     |
| goodsCount    | Number   | 商品数量合计 |
| postFee       | Number   | 运费         |
| totalPayPrice | Number   | 总价（实付） |
| totalPrice    | Number   | 总价         |

**userAddresses**

| 字段名称      | 数据类型 | 备注      |
| ------------- | -------- | --------- |
| address       | String   | 详细地址  |
| userAddresses | String   | 省市区/县 |
| receiver      | String   | 收货人    |
| contact       | String   | 联系电话  |

```tsx
/**
 * 立即购买
 */
export function getMemberOrderPreNow(data: GetMemberOrderPreNowData) {
  return http<GetMemberOrderPreResult>({
    method: 'GET',
    url: '/member/order/pre/now',
    data
  });
}
```

### 2. 创建订单

#### 变更收获地址：

在订单信息页面中默认使用用户的默认地址做为收货地址，如果用户想要更换收货地址也是被允许的，在用户点击订单信息页面中的收货地址后会跳转到【地址列表】中，用户重新选择地址后返回到订单信息页面，并将用户选择的收货地址设置为本订单的收货地址。

在用户点击收获地址区域时，跳转到地址列表，并且地址携带 `?from=order` 参数，这样在选择完地址后用来判断是否从订单创建页面跳转并选择完地址后回退到订单创建页。

收货地址升级成通过 Store 全局状态存储，方便地址列表页、订单填写页、商品详情页 多个页面使用，具体实现如下所示：

```tsx
// 选择收货地址
const changeAddress = (item: MemberAddressItem) => {
  // 只有从订单页面跳转过来选择地址后需要回退
  if (props.from === 'order') {
    // 更新 Stores 里的收货地址
    changeSelectedAddress(item);
    uni.navigateBack();
  }
};
```

在订单创建页面点击提交订单会调用接口创建新的订单，调用接口前需要先判断有没有收获地址：

```tsx
// 提交订单
const submitForm = async () => {
  // 从 Store 中获取选中的收货地址
  const addressId = selectedAddress.value.id;
  // 如果没有收货地址
  if (!addressId) {
    // 退出函数并弹窗提示
    return uni.showToast({ icon: 'none', title: '请选择收货地址~' });
  }
  // 调用创建订单的接口，获取订单id
  const { id } = await postMemberOrder({
    goods: orderPre.value.goods.map((v) => ({
      skuId: v.skuId,
      count: v.count
    })),
    addressId,
    deliveryTimeType: 1,
    payType: 1,
    payChannel: 2,
    buyerMessage: ''
  });
  // 跳转到订单详情页，并传递订单id
  uni.navigateTo({ url: `/pages/order/detail?id=${id}` });
};
```

接口调用：

接口地址：/member/order

请求方式：POST

登录权限: 是

请求参数：

**Body**

| 字段名称         | 是否必须 | 默认值 | 备注                             |
| ---------------- | -------- | ------ | -------------------------------- |
| goods            | 是       | 无     | 订单商品                         |
| addressId        | 是       | 无     | 收货地址 ID                      |
| deliveryTimeType | 是       | 无     | 配送时间                         |
| payType          | 是       | 无     | 支付方式                         |
| payChannel       | 是       | 无     | 支付渠道（小程序中固定微信支付） |
| buyerMessage     | 是       | 无     | 买家留言                         |

成功响应的数据：

| 字段名称   | 数据类型 | 备注         |
| ---------- | -------- | ------------ |
| id         | String   | 订单ID       |
| orderState | Number   | 订单状态     |
| payChannel | Number   | 支付渠道     |
| payType    | Number   | 支付方式     |
| createTime | String   | 创建订单时间 |

```tsx
/**
 * 提交订单
 */
export function postMemberOrder(data: PostMemberOrderData) {
  return http<PostMemberOrderResult>({
    method: 'POST',
    url: '/member/order',
    data
  });
}
```

### 3. 订单详情

创建订单成功后会跳转到订单详情页面，在这个页面中展示某一个订单的详细信息

#### 获取订单ID

首先在订单信息页面通过地址参数传递订单的 ID

```tsx
onLoad(async () => {
  if (props.id) {
    order.value = await getMemberOrderById(props.id);
  }
});
```

接口调用：

接口地址：/member/order/

请求方式：GET

登录权限: 是

请求参数：

**路径参数**

| 字段名称 | 是否必须 | 默认值 | 备注   |
| -------- | -------- | ------ | ------ |
| id       | 是       | 无     | 订单ID |

成功响应的数据：

| 字段名称        | 数据类型 | 备注     |
| --------------- | -------- | -------- |
| id              | String   | 订单ID   |
| orderState      | Number   | 订单状态 |
| payChannel      | Number   | 支付渠道 |
| payState        | Number   | 支付状态 |
| totalNum        | Number   | 商品数量 |
| totalMoney      | Number   | 商品总价 |
| postFee         | Number   | 运费     |
| payMoney        | Number   | 支付金额 |
| receiverContact | String   | 收货人   |
| receiverMobile  | String   | 联系电话 |
| receiverAddress | String   | 收货地址 |
| skus            | Array    | 订单商品 |

**skus**

| 字段名称  | 数据类型 | 备注           |
| --------- | -------- | -------------- |
| id        | String   | 商品ID         |
| name      | String   | 商品名称       |
| image     | String   | 商品图片       |
| quantity  | Number   | 商品数量       |
| attrsText | String   | 商品规格、型号 |
| curPrice  | Number   | 商品价格       |
| realPay   | Number   | 实付价格       |

```tsx
/**
 * 订单详情接口
 */
export function getMemberOrderById(id: string) {
  return http<GetMemberOrderByIdResult>({
    method: 'GET',
    url: `/member/order/${id}`
  });
}
```

### 4. 订单支付

#### 微信支付说明：

由于微信安全限制，该接口只允许申请通过的 `appid` 才能调用；

其他开发者更新订单状态，可调用模拟接口支付接口，调用后订单状态更新为已支付。

####  调用接口：

- 正式接口：支付-微信-小程序
- 模拟接口：模拟支付-更新订单支付状态

### 5. 订单列表

根据订单的不同状态展示订单列表。

##### Tab交互

在订单列表页面能够通过 Tab 的方法切换查看不同状态的订单列表，Tab 交互使用到了 swiper 组件，然后配合 current 属性和 change 事件来实现：

```tsx
// swiper切换
const handleSwiperChange = (e: any) => {
  tabsIndex.value = e.detail.current;
  activeIndex.value = e.detail.current;
  // 🔔优化：在滑动切换的时候，如果没有数据，才需要发送请求
  if (orderList.value[activeIndex.value].items.length === 0) {
    // 加载订单列表数据
    loadOrderList();
  }
};
```

```tsx
// 加载订单列表
const loadOrderList = async () => {
  uni.showLoading({ title: '加载中...' });
  // 获取当前订单列表
  const currOrderList = orderList.value[activeIndex.value];
  const res = await getMemberOrderList({
    page: currOrderList.page,
    pageSize: currOrderList.pageSize,
    orderState: OrderStateOptions[activeIndex.value].value
  });
  // 隐藏加载提示
  uni.hideLoading();
  // 列表数据追加，用于分页
  currOrderList.items.push(...res.items);
  // 记录总数，用于分页
  currOrderList.counts = res.counts;
  // 🔔如果 总记录数量 比 页容量还小，说明没分页数据了，页码无需累加
  if (res.counts < res.pageSize) return;
  // 页码累加，用于分页
  currOrderList.page++;
};
```

接口调用：

接口地址：/member/order

请求方式：GET

登录权限: 是

请求参数：

**Query**

| 字段名称   | 是否必须 | 默认值 | 备注         |
| ---------- | -------- | ------ | ------------ |
| orderState | 是       | 无     | 订单状态     |
| page       | 否       | 1      | 分页页码     |
| pageSize   | 否       | 10     | 每页数据数量 |

成功响应的数据：

| 字段名称   | 数据类型 | 备注     |
| ---------- | -------- | -------- |
| id         | String   | 订单ID   |
| orderState | Number   | 订单状态 |
| payChannel | Number   | 支付渠道 |
| payState   | Number   | 支付状态 |
| totalNum   | Number   | 商品数量 |
| totalMoney | Number   | 商品总价 |
| postFee    | Number   | 运费     |
| payMoney   | Number   | 支付金额 |
| skus       | Array    | 订单商品 |

**skus**

| 字段名称  | 数据类型 | 备注           |
| --------- | -------- | -------------- |
| id        | String   | 商品ID         |
| name      | String   | 商品名称       |
| image     | String   | 商品图片       |
| quantity  | Number   | 商品数量       |
| attrsText | String   | 商品规格、型号 |
| curPrice  | Number   | 商品价格       |
| realPay   | Number   | 实付价格       |

```tsx
/**
 * 订单详情接口
 */
export function getMemberOrderList(data: GetMemberOrderListData) {
  return http<GetMemberOrderListResult>({
    method: 'GET',
    url: `/member/order`,
    data
  });
}
```

