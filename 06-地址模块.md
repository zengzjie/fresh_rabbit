## 地址管理

- 获取不同类型的表单数据
- 动态设置导航栏的标题（新增和修改）
- 能够完成收获地址的增删改查
- 基于 `uni-ui` 的基础组件配合自定义封装的表单组件联合使用，提供 `validate` 对表单数据进行验证的功能

### 1.1  👀 查看地址

![image-20230228182054517](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302281820564.png)

```vue
<template>
  <view class="viewport">
    <scroll-view v-if="!loading && addressList.length > 0" scroll-y enhanced>
      <view class="address">
        <uni-swipe-action>
          <uni-swipe-action-item v-for="item in addressList" :key="item.id" class="swipe-cell">
            <view class="item" @tap="changeAddress(item)">
              <view class="user">
                {{ item.receiver }}
                <text>{{ item.contact }}</text>
                <text v-if="item.isDefault === 1" class="badge">默认</text>
              </view>
              <view class="locate">{{ item.fullLocation }}{{ item.address }}</view>
              <!-- 🐛 添加阻止冒泡 -->
              <navigator :url="`./form?id=${item.id}`" class="edit" hover-class="none" @tap.stop="() => {}">
                修改
              </navigator>
            </view>
            <template #right>
              <view class="swipe-cell--action">
                <button class="swipe-cell--action__delete" @tap="deleteAddressBtn(item.id)">删除</button>
              </view>
            </template>
          </uni-swipe-action-item>
        </uni-swipe-action>
      </view>
    </scroll-view>
    <view v-if="!loading && addressList.length === 0" class="empty">
      <uni-icons type="location" size="60" color="rgb(192, 196, 204)"></uni-icons>
      <text class="blank">收货地址为空</text>
    </view>
    <view v-if="!loading" class="footer" :class="{ 'safe-area-inset-bottom': true }">
      <button class="button" @tap="handleAddress">新建地址</button>
    </view>
  </view>
</template>
```

接口调用：

接口地址：/member/address

请求方式：GET

登录权限: 是

请求参数：无

成功响的数据：

| 字段名称     | 数据类型 | 备注           |
| ------------ | -------- | -------------- |
| id           | String   | ID             |
| receiver     | String   | 收货人姓名     |
| contact      | String   | 收货人联系方式 |
| fullLocation | String   | 完整收货地址   |
| isDefault    | Number   | 是否为默认     |

```tsx
/**
 * 获取收货地址列表
 */
export function getMemberAddress() {
  return http<MemberAddressItem[]>({
    method: 'GET',
    url: '/member/address'
  });
}
```



### 1.2 ➕ 添加地址

![image-20230228181830351](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302281818531.png)

布局分析：

```vue
<template>
  <view class="viewport">
    <view class="card">
      <XtxForm ref="formRef" :model="form" :rules="rules" label-position="left">
        <XtxFormItem key="receiver" label="姓名" prop="receiver" :required="true">
          <XtxInput v-model="form.receiver" placeholder="请填写收货人姓名" />
        </XtxFormItem>
        <XtxFormItem
          key="contact"
          label="手机号码"
          prop="contact"
          :required="true"
          :label-width="190"
          left-icon="phone"
        >
          <XtxInput v-model="form.contact" placeholder="请填写收货人手机号码" />
        </XtxFormItem>
        <XtxFormItem
          key="region"
          label="收获城市"
          prop="region"
          :required="true"
          :label-width="190"
          left-icon="location"
        >
          <XtxPicker
            v-model="form.region"
            mode="region"
            placeholder="请选择收货人所在城市"
            :presentation-text="form.regionAddress"
            @change="handleRegionChange"
          />
        </XtxFormItem>
        <XtxFormItem key="address" label="详细地址" prop="address" :required="true" :label-width="190" left-icon="home">
          <XtxInput v-model="form.address" placeholder="请填写街道、楼牌号信息" />
        </XtxFormItem>
        <XtxFormItem key="isDefault" label="设置默认地址" :label-width="230" left-icon="notification">
          <template #right>
            <switch
              :checked="form.isDefault === 1"
              color="#27ba9b"
              style="transform: scale(0.7)"
              @change="isDefaultChange"
            />
          </template>
        </XtxFormItem>
      </XtxForm>
    </view>
    <button class="button" @tap="submitFrom">{{ props.id ? '保存' : '确定' }}</button>
  </view>
</template>
```

```tsx
// model数据
const form = reactive({
  receiver: '', // 收货人姓名
  contact: '', // 收货人电话
  region: [], // 省市区编码
  regionAddress: '', // 省市区地址
  address: '', // 详细地址
  isDefault: 0, // 默认收货地址
  provinceCode: '', // 省编码
  cityCode: '', // 市编码
  countyCode: '' // 区编码
} as PostMemberAddressData);

// 获取 form 的实例，调用其内部的方法
const formRef = ref();

// 校验规则
const rules: Rules = reactive({
  receiver: [{ required: true, message: '请填写收货人姓名', trigger: ['blur', 'change'] }],
  contact: [
    { required: true, message: '请填写收货人电话', trigger: ['blur', 'change'] },
    // 由于小程序等的限制, 不能传递正则表达式, 需要通过字符串方式传递
    { pattern: '^1[3-9]\\d{9}$', message: '请填写正确的手机号码', trigger: 'change' }
  ],
  region: [{ type: 'array', required: true, message: '请选择省市区', trigger: ['blur', 'change'] }],
  address: [{ required: true, message: '请填写详细地址', trigger: ['blur', 'change'] }]
});
```

考虑到在小程序中使用表单的用法会跟我们所熟悉的UI库的表单不一样，这边就直接将表单组件封装了起来使用，看结构体使用格式是跟 `ElementUI` 、`Vant` 之类的表单使用是相差不大的。

✅ 提交表单则直接调用表单暴露出来的整体校验方法即可：

```tsx
const submitFrom = () => {
  // 先校验表单
  formRef.value.validate(async (valid: boolean) => {
    if (valid) {
      // 校验成功...
    }
  });
};
```

接口调用：

接口地址：/member/address

请求方式：POST

登录权限: 是

请求参数：

**Body**

| 字段名称     | 是否必须 | 默认值 | 备注                           |
| ------------ | -------- | ------ | ------------------------------ |
| receiver     | 是       | 无     | 收货人姓名                     |
| contact      | 是       | 无     | 收货人联系方式                 |
| provinceCode | 是       | 无     | 行政省对应的 code              |
| cityCode     | 是       | 无     | 行政市对应的 code              |
| countyCode   | 是       | 无     | 行政区县对应的 code            |
| address      | 是       | 无     | 收货人详细地址                 |
| isDefault    | 是       | 无     | 是否设置为默认地址（数值类型） |

```tsx
/**
 * 添加收货地址
 */
export function postMemberAddress(data: PostMemberAddressData) {
  return http({
    method: 'POST',
    url: '/member/address',
    data: data
  });
}
```

### 1.3 ✏️ 修改地址

![image-20230228185106966](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302281851034.png)

修改是跟新增一样，只需要通过地址参数 id 来区分当前是新增地址还是修改地址，并且动态设置导航栏标题。

```tsx
// 设置导航标题
onLoad(() => {
  uni.setNavigationBarTitle({
    title: props.id ? '编辑地址' : '新增地址'
  });
});
```

接口调用：

接口地址：/member/address/:id

请求方式：GET

登录权限: 是

请求参数：

**路径参数**

| 字段名称 | 是否必须 | 默认值 | 备注       |
| -------- | -------- | ------ | ---------- |
| id       | 是       | 无     | 收货地址ID |

成功响应的数据：

| 字段名称     | 数据类型 | 备注                |
| ------------ | -------- | ------------------- |
| receiver     | String   | 收货人姓名          |
| contact      | String   | 收货人联系方式      |
| provinceCode | Number   | 行政省对应的 code   |
| cityCode     | Number   | 行政市对应的 code   |
| countyCode   | Number   | 行政区县对应的 code |
| address      | String   | 收货人详细地址      |
| isDefault    | Number   | 是否设置为默认地址  |

```tsx
/**
 * 更新收货地址
 * @param id  收货地址 id
 * @param data 收货地址请求体参数
 */
export function putMemberAddress(id: string, data: PostMemberAddressData) {
  // PS: 修改成功的返回值如果业务中没用，可以不指定类型
  return http({
    method: 'PUT',
    url: `/member/address/${id}`,
    data: data
  });
}
```



### 1.4 ❌ 删除地址

![image-20230228185802168](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302281858231.png)

用户可以对地址列表中的收货地址进行删除，使用到了小程序组件 uni-ui 中的 侧滑组件。

接口调用：

接口地址：/member/address/:id

请求方式：DELETE

登录权限: 是

请求参数：

**路径参数**

| 字段名称 | 是否必须 | 默认值 | 备注 |
| -------- | -------- | ------ | ---- |
| id       | 是       | 无     | ID   |

```tsx
/**
 * 删除收货地址
 * @param id  收货地址 id
 */
export function deleteMemberAddressById(id: string) {
  // 注意：类型为单个收货地址，不要写成数组格式
  return http({
    method: 'DELETE',
    // 注意模板字符串 ${id} 的拼接
    url: `/member/address/${id}`
  });
}
```