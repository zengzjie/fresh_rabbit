## 登陆模块

![image-20230227181550920](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302271815978.png)

小程序中的登陆是通过用户授权的形式读取得到的，用户授权后开发者得到信息后帮用户完成注册/登录。

### 📱Login

![image-20230227181913204](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302271819260.png)

小程序【规定】要想获取用户手机号的授权，必须由用户主动【点击按钮】才可以，如下代码所示：

```vue
<button class="button phone" open-type="getPhoneNumber" @getphonenumber="onGetphonenumber">
  <text class="icon icon-phone"></text>
    手机号快捷登录
</button>
```

`open-type` 是 button 组件非常重的属性，通过它能够使用 button 获取如果调用 API 的能力，将 `open-type` 属性的值设置为 `getPhoneNumber` 后，当用户点击按钮时会弹出用户授权窗口。（个人账号不支持获取用户手机号）

在用户进行授权的过程中（允许/拒绝）会触发一个事件 `getphonenumber`，在这个事件回调函数中可以获取用户加密后的手机号码信息

出于安全考虑获取到的手机号码信息是加密码的，后端需要进行解密后才可以使用，而要想解密手机号码信息，无后端需要一个关键的数据 code（登录凭证），它是由调用 `wx.login` 得到的

```tsx
// 获取用户手机号
const onGetphonenumber = async (ev: any) => {
  try {
    // 获取 encryptedData, iv 参数
    const { encryptedData, iv } = ev.detail;
    console.log(encryptedData, iv, 'encryptedData, iv');
    // 调用发送微信登录请求
    const profile = await postLoginWxMin({
      code, // 必填参数：需通过 wx.login() 获取的 code
      encryptedData,
      iv
    });
    // 授权登录成功后续逻辑
    loginSuccess(profile);
  } catch {
    // 登录或注册失败
    uni.showToast({ title: '登录失败!', icon: 'none' });
  }
};
```

接口调用：

接口地址：/login/wxMin

请求方式：POST

登录权限: 否

请求参数：

**Body**

| 字段名称      | 是否必须 | 默认值 | 备注                         |
| ------------- | -------- | ------ | ---------------------------- |
| code          | 是       | 无     | wx.login 获取                |
| iv            | 是       | 无     | getphonenumber事件回调中获取 |
| encryptedData | 是       | 无     | getphonenumber事件回调中获取 |

成功响应的数据：

| 字段名称 | 数据类型 | 备注       |
| -------- | -------- | ---------- |
| id       | String   | 用户标识   |
| account  | String   | 账户名称   |
| avatar   | String   | 用户头像   |
| mobile   | String   | 用户手机号 |
| nickname | String   | 用户昵称   |
| token    | String   | 登录凭证   |

```tsx
/**
 * 小程序登录
 * @param data
 */
export function postLoginWxMin(data: PostLoginWxMinData) {
  return http<LoginWxMinResult>({
    method: 'POST',
    url: '/login/wxMin',
    data: data
  });
}
```

❗️模拟手机号登陆

授权获取手机号的功能 **目前该接口针对非个人开发者，且完成了认证的小程序开放（不包含海外主体）**

官方说明：[https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html](https://gitee.com/link?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fopen-ability%2FgetPhoneNumber.html)

接口调用：

接口地址：/login/wxMin/simple

请求方式：POST

登录权限: 否

请求参数：

**Body**

| 字段名称    | 是否必须 | 默认值 | 备注         |
| ----------- | -------- | ------ | ------------ |
| phoneNumber | 是       | 无     | 模拟的手机号 |

```tsx
 /**
 * 小程序登录_内测版
 * @param phoneNumber 模拟的手机号码
 */
export function postLoginWxMinSimple(phoneNumber: string) {
  return http<LoginWxMinResult>({
    method: 'POST',
    url: '/login/wxMin/simple',
    data: {
      phoneNumber: phoneNumber
    }
  });
}
```

### 👨🏻‍💻 用户信息存储

由于选用的是 Vue3 的版本，所以这里选择的状态管理库为🍍 `Pinia` ，用户信息存储在 `Stroe` 中，方便各个页面和组件获取用户信息。

`/src/stores/index.ts`

```tsx
import { createPinia } from 'pinia';
// pinia 持久化存储
import persist from 'pinia-plugin-persistedstate';

// 创建 pinia 实例
const pinia = createPinia();
// 为 pinia 添加持久化存储插件
pinia.use(persist);

export default pinia;

// 统一导出
export * from './modules/user';
```

`/src/stores/modules/user.ts`

```tsx
import { LoginWxMinResult } from '@/types/login';
import { defineStore } from 'pinia';
import { computed, ref } from 'vue';

export const useMemberStore = defindStore('user', () => {
  // 会员信息
  const profile = ref<LoginWxMinResult>({} as LoginWxMinResult);
  
  /**
   * @description: 设置会员信息
   * @param {LoginWxMinResult} 会员信息
   * @return {*}
   */
  const setProfileInfo = (info: LoginWxMinResult) => {
    profile.value = info;
  };
  
  /**
   * @description: 清空会员信息
   * @return {*}
   */
   const clearProfileInfo = () => {
     profile.value = {} as LoginWxMinResult;
   };
  
  /**
   * @description: 是否登陆
   * @return {*}
   */
   const isLogin = computed(() => Boolean(profile.value.token));
  
   return {
      profile,
      setProfileInfo,
      clearProfileInfo,
      isLogin
    };
},
{
	//persist: true // 这种写法在小程序中是不生效的，因为小程序的本地存储跟H5的api不同
  persist: {
    // storage: localStorage,
    // 🎯 改造成小程序的 api
    storage: {
      // 设置
      setItem(key, value) {
        uni.setStorageSync(key, value);
      },
      // 获取
      getItem(key) {
        uni.getStorageSync(key);
      }
    }
  }
});
```

在微信登录成功后会得到一个 token（凭证）后端基于这个 token 来分辨用户是否已登录，因此在每次发起请求的时候都需要将这个 token 再次发送给服务端进行校验。

这个 token 通常会以 HTTP 头信息的形式进行传递，在小兔鲜儿中使用的请求头为 Authorization，我们先将 token 记录下来，然后在每次请求的时候将 token 赋值给 Authorization 传递给后端。

```tsx
const loginSuccess = async (profile: LoginWxMinResult) => {
  // 保存用户信息到 Store 中
  memberStore.setProfileInfo(profile);
  // 登录成功提示
  uni.showToast({ icon: 'success', title: '登录成功' });
  setTimeout(() => {
    // 后退回到上一页
    uni.navigateBack({});
  }, 500);
};
```

## 👤 个人信息

![image-20230227200812952](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302272008060.png)

#### 1.1 展示信息

在用户进入到【我的】页面后，我们要把当前登陆用户的信息（昵称，头像）进行展示。

登陆状态：

只有用户处于登陆状态的时候我们才需要将用户的信息进行展示，否则都统一展示默认值，所以我们需要做的是首先需要检测用户的登录状态，而登录状态我们可以通过 `Pinia` 中存储的 `userModule` 中去取出 `isLogin` 来判断。

```tsx
import { useMemberStore } from '@/stores';
import { storeToRefs } from 'pinia';

const memberStore = useMemberStore();
const { isLogin, profile } = storeToRefs(memberStore);
```

```vue
<!-- 个人资料 -->
      <view class="profile">
        <view class="overview">
          <navigator v-if="isLogin" url="./profile" hover-class="none">
            <image mode="aspectFill" class="avatar" :src="profile.avatar"></image>
          </navigator>
          <!-- 未登录：点击头像跳转登录页 -->
          <navigator v-else url="/pages/login/index" hover-class="none">
            <!-- src="https://pcapi-xiaotuxian-front-devtest.itheima.net/miniapp/uploads/avatar_3.jpg" -->
            <image
              class="avatar"
              src="https://raw.githubusercontent.com/zengzjie/picgo-image/main/static_files/IMG_6247.JPG"
            ></image>
          </navigator>
          <view class="meta">
            <view v-if="isLogin" class="nickname" @tap="goToProfile">
              {{ profile.nickname }}
            </view>
            <!-- 未登录：点击文字跳转登录页 -->
            <navigator v-else url="/pages/login/index" hover-class="none" class="nickname">未登录</navigator>
            <view class="extra">
              <text v-if="!isLogin" class="tips">点击登录账号</text>
              <template v-else>
                <text class="update">更新头像昵称</text>
                <text class="relogin">切换账号</text>
              </template>
            </view>
          </view>
        </view>
        <navigator class="settings" url="./settings" hover-class="none">设置</navigator>
      </view>
```

根据用户的登录状态决定用户对个人信息内容进行点击时需要跳转到哪个页面，如果登录了则跳转到更新个人信息页面，否则跳转到登录页面。

![image-20230227203037507](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302272030577.png)

#### 1.2 更新头像信息

用户头像

修改头像需要调用小程序的 `chooseMedia` 的 API 读取用户相册或者拍照。

```tsx
// 修改头像
const changeAvatar = () => {
  uni.chooseMedia({
    count: 1,
    mediaType: ['image'],
    sourceType: ['album'],
    success: function (res) {
      console.log(JSON.stringify(res), 'JSONres');
      const filePath = res.tempFiles[0].tempFilePath;
      uni.uploadFile({
        url: '/member/profile/avatar', // 接口地址
        name: 'file',
        filePath: filePath,
        success(uploadFileRes) {
          // 更新当前页面的头像
          personalInfo.value.avatar = filePath;
          // 同步修改本地 Store 的头像
          setProfileInfo({
            ...profile,
            avatar: filePath
          });
          // 提示用户
          uni.showToast({ icon: 'success', title: '头像更新成功~' });
        }
      });
    }
  });
};
```

在项目前期工作中，我们在 `http` 中将小程序中的 `uni.uploadFile` 这个 API 添加到全局拦截器中。

接口调用：

接口地址：/member/profile/avatar

请求方式：POST

登录权限: 是

请求参数：

**Body**

| 字段名称 | 是否必须 | 默认值 | 备注                 |
| -------- | -------- | ------ | -------------------- |
| filePath | 是       | 无     | 新头像               |
| name     | 是       | 无     | 后端接口数据字段名称 |

#### 1.3 更新基本信息

在用户处理登录状态的时候，用户能够对各自的基本信息和用户头像进行修改，不过在进行个修改之前需要先将登录用户的信息查询出来，然后再在此基础上进行修改。

接口调用：

接口地址：/member/profile

请求方式：GET

登录权限: 是

请求参数：无

成功响应的数据：

| 字段名称   | 数据类型 | 备注         |
| ---------- | -------- | ------------ |
| id         | String   | 用户ID       |
| account    | String   | 用户账号名称 |
| nickname   | String   | 用户昵称     |
| avatar     | String   | 用户头像地址 |
| gender     | String   | 用户性别     |
| profession | String   | 用户职业     |
| birthday   | String   | 用户生日     |

```tsx
/**
 * 个人信息-修改
 */
export function putMemberProfile(data: PutMemberProfileData) {
  return http<GetMemberProfileResult>({
    method: 'PUT',
    url: '/member/profile',
    data: data
  });
}
```

我们通过 `input` 、`radio` 、`picker` 的 `change` 事件去监听选中的值最终在 `form` 的 `submit` 事件中去组合提交更新用户的信息，并且将信息同步更新到 `Store` 中

```tsx
const submitForm = async () => {
  // 获取后端修改所需字段
  const { birthday, gender, nickname, profession } = personalInfo.value;
  // 🔔 数组按下标解构 省 市 区 的编码
  const [provinceCode, cityCode, countyCode] = fullLocationCode;
  console.log(birthday, gender, nickname, profession, provinceCode, cityCode, countyCode, 'personalInfo');
  // 调用修改个人信息接口
  await putMemberProfile({
    birthday,
    gender,
    nickname,
    profession,
    provinceCode,
    cityCode,
    countyCode
  });
  // 提示用户 - 后退返回上一页（正常的流程：个人中心点击修改资料跳转到当前页，修改完成后退回去）
  uni.showToast({
    icon: 'success',
    title: '保存成功',
    success: () =>
      setTimeout(() => {
        uni.navigateBack();
      }, 1000)
  });
  // 🐛 同步更新 Store 的昵称和职业
  setProfileInfo({
    ...profile,
    nickname,
    profession
  });
};
```

#### 1.4 自定义头部导航样式

🔧 适配不同机型的自定义头部导航，并且导航背景图的高度自适应

![image-20230227235551792](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202302272355904.png)

布局分析：

```vue
<template>
  <view class="header" :style="style">
    <view
      class="header-box"
      :style="[
        {
          height: props.bgHeight ? props.bgHeight + 'rpx' : customBarHeight + 'px',
          paddingTop: statusBarHeight + 'px',
          color: titleColor,
          background: bgAttribute
        }
      ]"
    >
      <view @tap="goBack">
        <slot name="back">返回</slot>
      </view>
      <view class="header-box__title">
        {{ title }}
      </view>
      <view style="width: 32px"></view>
    </view>
  </view>
</template>
```

```tsx
import { onLoad } from '@dcloudio/uni-app';
import { ref, computed } from 'vue';
import useCurrentInstance from '@/hooks/useCurrentInstance';

const { globalProperties } = useCurrentInstance();

// 自定义条形图高度
const customBarHeight = ref(0);
// 状态栏高度
const statusBarHeight = ref(0);
// 如果有传入自定义背景图高度则优先使用，否则直接采取自定义栏高度
const style = computed(() => `height: ${props.bgHeight ? props.bgHeight + 'rpx' : customBarHeight.value + 'px'}`);

onLoad(() => {
  // 不同机型的状态栏高度
  statusBarHeight.value = globalProperties.$StatusBar + 10;
  // 自定义栏的高度
  customBarHeight.value = globalProperties.$CustomBar + 10;
});

const goBack = () => {
  uni.navigateBack();
};
```

示例：

```tsx
<XtxHeaderBar
  title="个人信息"
  title-color="#fff"
  :bg-attribute="bgAttribute"
  :bg-height="globalProperties.$StatusBar + 392"
>
  <template #back>
    <view class="icon-left" style="width: 32px; transform: translateY(3px)"></view>
  </template>
</XtxHeaderBar>

// 背景属性
const bgAttribute = ref(
  `url(https://pcapi-xiaotuxian-front-devtest.itheima.net/miniapp/images/order_bg.png) no-repeat 0 / auto ${
    globalProperties.$StatusBar + 392
  }rpx`
);
```

