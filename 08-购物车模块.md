## 🛒 购物车

购物车是任何电商项目都不可缺少的，除了添加、查询、修改及删除购物车等功能外，购物车还需要处理用户的交互，如选中商品、取消选中商品、全选，并且在用户的操作过程中实时的计算购物车中待购买商品总的金额。

![image-20230302162254832](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/202303021622013.png)

布局分析：

```vue
<template>
  <scroll-view class="viewport" scroll-y enhanced :show-scrollbar="false" @scrolltolower="onScrollTolower">
    <template v-if="isLogin">
      <!-- 优惠提示 -->
      <view class="tips">
        <text class="label">满减</text>
        <text class="desc">满1件，即可享受9折优惠</text>
      </view>
      <view v-if="carts.length === 0" class="blank">购物车还是空的，快来挑选好货吧！</view>
      <!-- 购物车商品 -->
      <view v-else class="carts">
        <uni-swipe-action>
          <uni-swipe-action-item v-for="item in carts" :key="item.skuId" class="swipe-cell">
            <navigator hover-class="none" :url="'/pages/goods/index?id=' + item.id" class="card">
              <!-- 选择框 -->
              <text
                :class="['checkbox', `icon-${item.selected ? 'checked' : 'ring'}}`]"
                @tap.stop="changeSelected(item.skuId)"
              ></text>
              <!-- 商品图片 -->
              <image :src="item.picture" mode="aspectFit" class="image"></image>
              <!-- 商品信息 -->
              <view class="meta">
                <view class="name ellipsis">{{ item.name }}</view>
                <!-- 商品类型 -->
                <view class="type ellipsis">{{ item.attrsText }}</view>
                <view class="footer">
                  <!-- 商品价格 -->
                  <view class="price">¥{{ item.price }}</view>
                  <!-- 商品数量 需要阻止冒泡 防止跳转到商品信息页 -->
                  <view class="quatity" @tap.stop="() => {}">
                    <text class="text" @tap="changeCount(item.skuId, -1)">-</text>
                    <input
                      v-model="item.count"
                      class="input"
                      type="number"
                      @change="(e) => handleCountChange(e, item.skuId)"
                    />
                    <text class="text" @tap="changeCount(item.skuId, 1)">+</text>
                  </view>
                </view>
              </view>
            </navigator>
            <template #right>
              <view class="swipe-cell-action">
                <button class="collect-button">移入收藏</button>
                <button class="delete-button" @tap="deleteCart([item.skuId])">删除</button>
              </view>
            </template>
          </uni-swipe-action-item>
        </uni-swipe-action>
      </view>
    </template>
    <template v-else>
      <view class="blank">
        <text>登陆后可查看购物车中的商品</text>
        <navigator hover-class="none" url="/pages/login/index">
          <button class="button">去登陆</button>
        </navigator>
      </view>
    </template>

    <XtxGuess ref="guessRef" />
  </scroll-view>

  <!-- 吸底工具栏 -->
  <view v-if="isLogin && carts.length !== 0" class="toolbar">
    <view :class="['all', isAllSelected ? 'checked' : '']" @tap="changeSelectedAll">全选</view>
    <view class="total">
      <text class="text">合计：</text>
      <text class="amount">{{ selectedCartsAmount }}</text>
    </view>
    <view class="buttons">
      <view :class="['button', 'payment', selectedCartsCount === 0 ? 'disabled' : '']" @tap="goToOrderCreate">
        去结算（{{ selectedCartsCount }}）
      </view>
    </view>
  </view>
</template>
```

判断用户是否已经登录，若是登录状态则直接获取购物车的信息展示，否则展示提示用户前往登录。

### 1. 购物车信息

```tsx
// 购物车商品列表
const carts = ref<MemberCartItem[]>([]);

const loadMemberCart = async () => {
  carts.value = await getMemberCart();
};

/* 这里需要用onShow, 因为onLoad只会触发一次, 当没有登录的时候切到购物车页面然后去登陆后在回来就不会触发了 */
onShow(() => {
  if (isLogin.value) {
    // 如果已经登录，直接获取购物车数据
    loadMemberCart();
  }
});
```

接口调用：

在对规格/型号以及用户的登录情况进行验证后，就可以调用接口添加商品到购物车了，要实现这个功能只需要调用接口就可以了，同时需要处一些简单的交互，如验证、关闭弹层等。

接口地址：/member/cart

请求方式：POST

登录权限: 是

请求参数：

**Body**

| 字段名称 | 是否必须 | 默认值 | 备注         |
| -------- | -------- | ------ | ------------ |
| skuId    | 是       | 无     | 商品库存单位 |
| count    | 是       | 无     | 购买商品数量 |

```tsx
/**
 * 获取购物车列表接口
 */
export function getMemberCart() {
  return http<MemberCartItem[]>({
    method: 'GET',
    url: '/member/cart'
  });
}
```

### 2. 勾选商品

传递点击商品的 `skuId` 传递给后端去修改商品的状态

接口调用：

接口地址：/member/cart/:id

请求方式：PUT

登录权限: 是

请求参数：

**路径参数**

| 字段名称 | 是否必须 | 默认值 | 备注  |
| -------- | -------- | ------ | ----- |
| id       | 是       | 无     | skuId |

**Body**

| 字段名称 | 是否必须 | 默认值 | 备注     |
| -------- | -------- | ------ | -------- |
| selected | 是       | 无     | 选中状态 |
| count    | 是       | 无     | 商品数量 |

```tsx
/**
 * 修改购物车商品
 */
export function putMemberCartById(skuId: string, data: PutMemberCartData) {
  return http({
    method: 'PUT',
    url: `/member/cart/${skuId}`,
    data
  });
}
```

### 3. 全选商品

点击底部的全选按钮

接口调用：

接口地址：/member/cart/selected

请求方式：PUT

登录权限: 是

请求参数：

**路径参数**

| 字段名称 | 是否必须 | 默认值 | 备注  |
| -------- | -------- | ------ | ----- |
| id       | 是       | 无     | skuId |

**Body**

| 字段名称 | 是否必须 | 默认值 | 备注     |
| -------- | -------- | ------ | -------- |
| selected | 是       | 无     | 是否全选 |
| ids      | 否       | 无     | 商品集合 |

```tsx
/**
 * 购物车全选/取消全选
 */
export function putMemberCartSelected(data: PutMemberCartSelectedData) {
  return http({
    method: 'PUT',
    url: '/member/cart/selected',
    data
  });
}
```

### 4. 计算总金额

```tsx
// 计算以选中的商品数量
const selectedCarts = computed(() => carts.value.filter((item) => item.selected));

// 计算以选中的商品数量总数
const selectedCartsCount = computed(() => selectedCarts.value.reduce((sum, item) => sum + Number(item.count), 0));

// 计算选中商品的总价
const selectedCartsAmount = computed(() =>
  selectedCarts.value.reduce((sum, item) => sum + Number(item.count) * Number(item.price), 0)
);
```

### 5. 改变商品数量

根据其最小最大值去判断点击加减按钮的动作。

```tsx
// 改变商品数量
const changeCount = (skuId: string, num: number) => {
  // 根据 skuId 查找出待修改的商品
  const item = carts.value.find((v) => v.skuId === skuId);
  if (item) {
    // 先保存一个临时的数据，用于边界判断
    const temp = Number(item.count) + num;
    if (Number(temp) < 1) {
      uni.showToast({
        title: '商品数量不能小于1',
        icon: 'none'
      });
      return;
    }
    if (Number(temp) > item.stock) {
      uni.showToast({
        title: `商品数量不能大于${item.stock}`,
        icon: 'none'
      });
      return;
    }
    item.count = temp.toString();
    // 发送请求让后端更新商品数量
    putMemberCartById(skuId, { count: Number(item.count) });
  }
};
```

### 6. 删除购物车

逻辑：

```tsx
// 删除购物车
const deleteCart = (ids: string[]) => {
  uni.showModal({
    title: '提示',
    content: '是否要删除商品',
    success: async function (res) {
      if (res.confirm) {
        await deleteMemberCart({ ids: ids });
        // 删除成功后重新获取购物车列表
        loadMemberCart();
        uni.showToast({
          title: '删除成功',
          icon: 'none'
        });
      }
    }
  });
};
```

接口调用：

接口地址：/member/cart

请求方式：DELETE

登录权限: 是

请求参数：

**Body**

| 字段名称     | 是否必须 | 默认值 | 备注             |
| ------------ | -------- | ------ | ---------------- |
| ids          | 是       | 无     | 商品的 skuId     |
| clearAll     | 是       | 无     | 是否清空         |
| clearInvalid | 是       | 无     | 是否清空无效商品 |

```tsx
/**
 * 删除/清空购物车商品
 */
export function deleteMemberCart(data: DeleteMemberCartData) {
  return http({
    method: 'DELETE',
    url: '/member/cart',
    data
  });
}
```

