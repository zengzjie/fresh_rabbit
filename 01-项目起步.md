# åˆ›å»ºä»¥ typescript å¼€å‘çš„å·¥ç¨‹  

```shell
npx degit dcloudio/uni-preset-vue#vite-ts vue3-vite-fresh_rabbit
```

```shell
// è¿›å…¥é¡¹ç›®å·¥ç¨‹
cd vue3-vite-fresh_rabbit
// å®‰è£…ä¾èµ–
yarn

// è¿è¡Œé¡¹ç›®
yarn dev:mp-weixin
```

â—ï¸å¦‚æœå‘ç°è¿è¡Œäº†é¡¹ç›®åç»ˆç«¯è¾“å‡ºçš„å†…å®¹å¦‚ä¸‹ï¼š

![image-20230226221407823](https://cdn.jsdelivr.net/gh/zengzjie/picgo-image@main/static_files/image-20230226221407823.png)

å…¶å®è¿™æ ·é¡¹ç›®æ˜¯å·²ç»å¯åŠ¨èµ·æ¥äº†ï¼Œåªæ˜¯çœ‹ä¸åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„Ipåœ°å€ä¿¡æ¯

åªéœ€è¦åœ¨ `package.json` ä¸­çš„ `dev:h5` åé¢åŠ ä¸Š `info` ï¼š`"dev:h5": "uni -l info"`

### 1. ç»„ä»¶åº“

ç»„ä»¶ - æ‰©å±•ç»„ä»¶ï¼ˆuni-uiï¼‰

å®‰è£… `sass`

```shell
yarn add sass -D
```

å®‰è£… `uni-ui`

```shell
yarn add @dcloudio/uni-ui
```

é…ç½® `easycom` 

```
// pages.json
{
	// ç»„ä»¶è‡ªåŠ¨å¼•å…¥è§„åˆ™
  "easycom": {
    "autoscan": true,
    "custom": {
      // å®‰è£… uni-ui ç»„ä»¶åº“æ­¥éª¤ï¼š
      //   1. å®‰è£… sassï¼š å‚è€ƒå‘½ä»¤ pnpm i sass -D
      //   2. å®‰è£… uni-uiï¼šå‚è€ƒå‘½ä»¤ pnpm i @dcloudio/uni-ui
      //   3. é…ç½® easycom ç»„ä»¶è‡ªåŠ¨å¯¼å…¥è§„åˆ™
      //   4. é…ç½® vite.config.ts
      //   5. ä½¿ç”¨ ç»„ä»¶åº“
      // uni-ui è§„åˆ™å¦‚ä¸‹é…ç½®
      "^uni-(.*)": "@dcloudio/uni-ui/lib/uni-$1/uni-$1.vue"
    }
  }
}
```

åœ¨ `template` ä¸­ä½¿ç”¨ç»„ä»¶ï¼š

```vue
<uni-badge text="1"></uni-badge>
<uni-badge text="2" type="success"></uni-badge>
<uni-badge text="3" type="primary" :inverted="true"></uni-badge>
```

â—ï¸ä½¿ç”¨ yarn æˆ–è€… npm å®‰è£…çš„ç»„ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ `babel-loader` ä¼šå¿½ç•¥æ‰€æœ‰ `node_modules` ä¸­çš„æ–‡ä»¶ï¼Œå¯¼è‡´æ¡ä»¶ç¼–è¯‘å¤±æ•ˆï¼Œéœ€è¦é€šè¿‡é…ç½® `vite.config.ts` è§£å†³ï¼š

```tsx
export default defineConfig({
  // ä¾èµ–é¢„æ„å»º
    optimizeDeps: {
      entries: ['@dcloudio/uni-ui']
    }
})
```

`vite.config.ts` ç›¸å…³é…ç½®

```tsx
import { defineConfig, loadEnv, UserConfig } from 'vite';
import * as path from 'path';
import uni from '@dcloudio/vite-plugin-uni';

// https://vitejs.dev/config/
export default defineConfig(({ command, mode }) => {
  const env = loadEnv(mode, process.cwd());

  const config: UserConfig = {
    plugins: [uni()],
    resolve: {
      alias: {
        '@': path.resolve(__dirname, './src')
      }
    },
    css: {
      preprocessorOptions: {
        // ç»Ÿä¸€å¼•å…¥å…¬å…±é¢œè‰²å˜é‡æ–‡ä»¶ï¼Œå¯åœ¨å…¨å±€ä¸­ç›´æ¥ä½¿ç”¨
        scss: { charset: false, additionalData: `@import "@/styles/variables.scss";` }
      }
    },
    // ä¾èµ–é¢„æ„å»º
    optimizeDeps: {
      entries: ['@dcloudio/uni-ui']
    }
  };

  if (command === 'serve') {
    // å¼€å‘
    return config;
  } else {
    // ç”Ÿäº§
    return config;
  }
});

```



### 2. æ¥å£æ–‡æ¡£ & è§„èŒƒ

æ¥å£æ–‡æ¡£åœ°å€ï¼š [https://www.apifox.cn/apidoc/shared-0e6ee326-d646-41bd-9214-29dbf47648fa](https://gitee.com/link?target=https%3A%2F%2Fwww.apifox.cn%2Fapidoc%2Fshared-0e6ee326-d646-41bd-9214-29dbf47648fa)

æ¥å£æœåŠ¡å™¨åŸºåœ°å€ä¸º: [https://pcapi-xiaotuxian-front-devtest.itheima.net](https://gitee.com/link?target=https%3A%2F%2Fpcapi-xiaotuxian-front-devtest.itheima.net)

#### 2.1 è¯·æ±‚è§„èŒƒ

è°ƒç”¨æ¥å£å‘å‡ºè¯·æ±‚æ—¶ï¼Œè¯·æ±‚å‚æ•°çš„ç±»å‹æœ‰å¤šç§ç±»å‹ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ä¸åŒç±»å‹å‚æ•°çš„å«ä¹‰åŠå…¶åœ¨å°ç¨‹åºçš„ä½¿ç”¨ï¼Œç±»å‹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| å‚æ•°ç±»å‹ | å«ä¹‰                  | è¯´æ˜                         |
| -------- | --------------------- | ---------------------------- |
| query    | è¯·æ±‚åœ°å€ ? åé¢çš„å‚æ•° | å°ç¨‹åºä¸­é€šè¿‡ data è¿›è¡Œè®¾ç½®   |
| body     | è¯·æ±‚ä¸»ä½“ä¸­çš„å‚æ•°      | å°ç¨‹åºä¸­é€šè¿‡ data è¿›è¡Œè®¾ç½®   |
| headers  | è¯·æ±‚å¤´ä¸­çš„å‚æ•°        | å°ç¨‹åºä¸­é€šè¿‡ header è¿›è¡Œè®¾ç½® |

åœ¨å°ç¨‹åºä¸­ä¸åŒç±»å‹å‚æ•°çš„ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```tsx
uni.request({
  url: '',
  method: 'GET',
  // header ç±»å‹å‚æ•°ä½¿ç”¨ header è¿›è¡Œä¼ é€’
  header: {
    Authorization: 'Bearer 45sdxzfdkffdfs43...'
  },
  // æ— è®ºæ˜¯ query æˆ–æ˜¯ body ç±»å‹å‚æ•°å‡ä½¿ç”¨ data è¿›è¡Œä¼ é€’
  data: {
    id: '435754'
  }
})
```

**åœ¨å°ç¨‹åºä¸­æ— è®ºæ˜¯ query æˆ–æ˜¯ body ç±»å‹çš„å‚æ•°å‡ä½¿ç”¨ data è¿›è¡Œä¼ é€’ï¼Œheaders ç±»å‹çš„å‚æ•°ä½¿ç”¨ header è¿›è¡Œä¼ é€’ã€‚**

#### 2.2 å“åº”è§„èŒƒ

åœ¨è°ƒç”¨æ¥å£åå“åº”çš„æ•°æ®ä¸­ä¼šåŒ…å«ä¸€äº›å›ºå®šçš„å­—æ®µï¼Œåˆ†æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å½¢ï¼š

è°ƒç”¨æ¥å£æˆåŠŸæ—¶åŒ…å«çš„å­—æ®µä¸ºï¼š

| å­—æ®µåç§° | å«ä¹‰         | ç¤ºä¾‹     |
| -------- | ------------ | -------- |
| msg      | æˆåŠŸæç¤ºä¿¡æ¯ | æ“ä½œæˆåŠŸ |
| result   | æ•°æ®ç»“æœ     |          |

### 3. å°è£… `uni.request`

```tsx
// é¦–é€‰æœåŠ¡å™¨
const baseUrl = 'https://pcapi-xiaotuxian-front-devtest.itheima.net';

// å¤‡é€‰æœåŠ¡å™¨
const backupUrl = 'https://pcapi-xiaotuxian-front.itheima.net';

// https://uniapp.dcloud.net.cn/api/interceptor.html#
// æŠ½ç¦»æ‹¦æˆªå™¨é…ç½® request å’Œ uploadFile å¤ç”¨
const httpInterceptor = {
  // æ‹¦æˆªå‰è§¦å‘
  invoke(args: UniApp.RequestOptions) {
    // å¦‚æœä¸æ˜¯ http å¼€å¤´çš„ï¼Œæˆ‘ä»¬æ‰éœ€è¦è¿›è¡Œ URL æ‹¼æ¥
    if (args.url.startsWith('http') === false) {
      // request è§¦å‘å‰æ‹¼æ¥ url
      args.url = baseUrl + args.url;
    }
    // å°ç¨‹åºç«¯è°ƒç”¨ï¼Œè¯·æ±‚å¤´ä¸­headerä¸­å¿…é¡»æ·»åŠ ï¼šsource-clientï¼šminiapp
    args.header = {
      ...args.header,
      'source-client': 'miniapp' // æ·»åŠ å°ç¨‹åºç«¯è°ƒç”¨æ ‡è¯†
    };
    // åœ¨évueæ–‡ä»¶ä¸­ï¼Œå“ªé‡Œä½¿ç”¨ store å°±å“ªé‡Œè°ƒç”¨
    const memberStore = useMemberStore();
    // è·å–token
    const token = memberStore.profile.token;
    // å¦‚æœæœ‰tokenï¼Œå°±æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­
    if (token) {
      args.header.Authorization = token;
    }
  }
};

// éœ€è¦æ·»åŠ åˆšåˆšå†™æ‹¦æˆªå™¨ï¼Œæ‹¦æˆª request
uni.addInterceptor('request', httpInterceptor);
// æ‹¦æˆª uploadFile
uni.addInterceptor('uploadFile', httpInterceptor);

interface ApiREsponse {
  // ä¸šåŠ¡çŠ¶æ€ç 
  code: string;
  // å“åº”æ•°æ®
  result: any;
  // å“åº”ä¿¡æ¯
  msg: string;
  // é”™è¯¯ä¿¡æ¯
  message?: string;
}

/**
 * @description: å°è£…é€šè¿‡çš„è¯·æ±‚ http æ–¹æ³•
 * @param {string} options è¯·æ±‚å‚æ•°
 * @return {*}
 */

export function http<T>(options: UniApp.RequestOptions) {
  // è¿”å› Promise å¯¹è±¡
  // Promise çš„æ³›å‹ç”¨äºç¡®è®¤ resolve çš„ç±»å‹
  return new Promise<T>((resolve, reject) => {
    uni.request({
      // åº”ç”¨æ‰€æœ‰çš„å‚æ•°
      ...options,
      // success æˆåŠŸå›è°ƒ
      // ğŸš¨ uni.request å’Œ axios çš„è¯·æ±‚æˆåŠŸå›è°ƒå‚æ•°ä¸ä¸€æ ·ï¼š
      // 1. å°ç¨‹åºä¸­ uni.request æ”¶åˆ°æœåŠ¡ç«¯å“åº”åå°±ä»£è¡¨æˆåŠŸï¼Œä¸ç®¡çŠ¶æ€ç æ˜¯å¤šå°‘
      // 2. ç½‘é¡µç«¯ axios æ”¶åˆ°æœåŠ¡ç«¯å“åº”åï¼Œåªæœ‰çŠ¶æ€ç æ˜¯ 2xx æ‰ä»£è¡¨æˆåŠŸï¼Œå…¶ä»–çŠ¶æ€ç éƒ½æ˜¯å¤±è´¥
      success: (res) => {
        // ä¸šåŠ¡çŠ¶æ€ç 
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve((res.data as ApiREsponse).result);
        } else if (res.statusCode === 401) {
          // æœªç™»å½•
          uni.navigateTo({
            url: '/pages/login/index'
          });
          // æ ‡è®°ä¸ºå¤±è´¥
          reject(res);
        } else {
          console.log(' âŒå¤±è´¥', res);
          // é€šçŸ¥é”™è¯¯æç¤º
          uni.showToast({
            icon: 'none',
            title: (res.data as ApiREsponse).message || 'è¯·æ±‚å¤±è´¥'
          });
          // ğŸ¯ æ ‡è®°ä¸ºå¤±è´¥ï¼šreject å¯è®© await åé¢çš„ä»£ç ä¸æ‰§è¡Œï¼Œæ›´ç¬¦åˆç¼–ç¨‹é€»è¾‘
          reject(res);
        }
      },
      // å¤±è´¥ï¼ˆç½‘ç»œï¼‰
      fail: (err) => {
        reject(err);
      }
    });
  });
}

// ä¹Ÿå¯ä»¥ä½¿ç”¨ axios å»å°è£…, ä½¿ç”¨ adapter é€‚é…å°ç¨‹åº
// const http = axios.create({
//   baseURL,
//   withCredentials: true,
//   timeout: 5000
// });

// http.defaults.addpter = function (config: any) {
//   // è¿”å› Promise
//   return new Promise(( resolve, reject ) => {});
// };

// export { http };
```

### 4.  `main.ts` 

è¿™é‡Œæˆ‘ä¸»è¦åšäº†å°†ä¸€äº›å¸¸ç”¨åˆ°çš„çŠ¶æ€å˜é‡éƒ½æŒ‚è½½åˆ°å…¨å±€ä¸‹ï¼Œè¿™æ ·åœ¨æ¯ä¸ªé¡µé¢ä¸­éƒ½åªéœ€è¦å»é€šè¿‡è°ƒç”¨ `getcurrentInstance()` å»è·å–ï¼Œå°†å¸¸ç”¨çš„å·¥å…·å‡½æ•°éƒ½åœ¨ `main` ä¸‹ä½¿ç”¨ use å»æ³¨å†Œä½¿ç”¨ï¼ˆä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨ `getcurrentInstance()` ï¼‰

```tsx
import { createSSRApp } from 'vue';
import App from './App.vue';
import pinia from './stores';
import xUtils from './utils';

export function createApp() {
  const app = createSSRApp(App);
  // æŒ‚è½½ lodash åˆ°å…¨å±€
  app.config.globalProperties.$_ = _;
  uni.getSystemInfo({
    success: function (e: any) {
      // æŒ‚è½½åˆ°å…¨å±€ä¸­ï¼Œé€šè¿‡ const { proxy, ctx } = getcurrentInstance(); è·å–ï¼Œå»ºè®®ä½¿ç”¨ proxy å»è·å–æŒ‚è½½çš„å±æ€§ï¼Œctx æ‰“åŒ…åå†…å®¹å¯èƒ½æ‹¿ä¸åˆ°
      // #ifndef MP
      app.config.globalProperties.$StatusBar = e.statusBarHeight;
      if (e.platform == 'android') {
        app.config.globalProperties.$CustomBar = e.statusBarHeight + 50;
      } else {
        app.config.globalProperties.$CustomBar = e.statusBarHeight + 45;
      }
      // #endif

      // #ifdef MP-WEIXIN
      app.config.globalProperties.$StatusBar = e.statusBarHeight;
      const custom = uni.getMenuButtonBoundingClientRect();
      app.config.globalProperties.$Custom = custom;
      app.config.globalProperties.$CustomBar = custom.bottom + custom.top - e.statusBarHeight;
      // #endif

      //çª—å£é«˜åº¦
      app.config.globalProperties.$windowHeight = e.windowHeight;
      //è·å–å¯¼èˆªé«˜åº¦
      app.config.globalProperties.$navHeight = e.statusBarHeight * (750 / e.windowWidth) + 91;
      // åœ¨ç«–å±æ­£æ–¹å‘ä¸‹çš„å®‰å…¨åŒºåŸŸæ’å…¥ä½ç½®
      app.config.globalProperties.$safeAreaInsets = e.safeAreaInsets;
      app.config.globalProperties.$SystemInfo = e;
    }
  });
  app.use(pinia);
  app.use(xUtils);

  return {
    app
  };
}

```

